# Makefile for es with organized directory structure
# Based on original Makefile ($Revision: 1.4 $)

prefix          = @prefix@
datarootdir     = @datarootdir@
datadir         = @datadir@
exec_prefix     = @exec_prefix@
mandir          = @mandir@
bindir          = @bindir@
srcdir          = @srcdir@
testdir         = @srcdir@/test

VPATH           = $(srcdir)

SHELL           = /bin/sh
CC              = @CC@
YACC            = @YACC@
INSTALL         = @INSTALL@
INSTALL_PROGRAM = $(INSTALL)
INSTALL_DATA    = $(INSTALL) -m 644
MKDIR_P         = @MKDIR_P@

# Include paths for new structure
CFLAGS          = @STRICT_CFLAGS@ -I. -I$(srcdir) -Iinclude -I$(srcdir)/include \
                  -W -Wall @READLINE_CFLAGS@ @CFLAGS@ $(ADDCFLAGS)
LDFLAGS         = @LDFLAGS@ $(ADDLDFLAGS)
LIBS            = @READLINE_LIBS@ @LIBS@ $(ADDLIBS)

# Header files (now in include/)
HFILES          = include/config.h include/es.h include/gc.h include/input.h \
                  include/prim.h include/print.h include/sigmsgs.h \
                  include/stdenv.h include/syntax.h include/debug.h

# Source files by category
CORE_CFILES     = src/core/eval.c src/core/gc.c src/core/main.c
PRIMITIVE_CFILES = src/primitives/prim.c src/primitives/prim-ctl.c \
                  src/primitives/prim-etc.c src/primitives/prim-io.c \
                  src/primitives/prim-math.c src/primitives/prim-sys.c
PARSER_CFILES   = src/parser/syntax.c src/parser/token.c
IO_CFILES       = src/io/input.c src/io/heredoc.c src/io/fd.c src/io/open.c \
                  src/io/proc.c src/io/term.c
DATA_CFILES     = src/data/str.c src/data/list.c src/data/split.c \
                  src/data/glom.c src/data/conv.c src/data/dict.c \
                  src/data/tree.c src/data/vec.c
UTILS_CFILES    = src/utils/debug.c src/utils/print.c src/utils/match.c \
                  src/utils/glob.c src/utils/util.c src/utils/var.c
SYSTEM_CFILES   = src/system/access.c src/system/signal.c src/system/status.c \
                  src/system/history.c src/system/opt.c src/system/except.c \
                  src/system/closure.c
BUILD_CFILES    = src/build/dump.c src/build/version.c

# All source files
CFILES          = $(CORE_CFILES) $(PRIMITIVE_CFILES) $(PARSER_CFILES) \
                  $(IO_CFILES) $(DATA_CFILES) $(UTILS_CFILES) \
                  $(SYSTEM_CFILES) $(BUILD_CFILES) y.tab.c sigmsgs.c

# Object files (remove y.tab.c and sigmsgs.c, add y.tab.o and sigmsgs.o separately)
MAIN_CFILES     = $(CORE_CFILES) $(PRIMITIVE_CFILES) $(PARSER_CFILES) \
                  $(IO_CFILES) $(DATA_CFILES) $(UTILS_CFILES) $(SYSTEM_CFILES)
OFILES          = $(MAIN_CFILES:.c=.o) y.tab.o sigmsgs.o src/build/version.o

# Generated files
GEN             = esdump y.tab.c y.tab.h y.output token.h sigmsgs.c initial.c

SIGFILES        = @SIGFILES@

es              : $(OFILES) initial.o
	$(CC) -o es $(LDFLAGS) $(OFILES) initial.o $(LIBS)

esdump          : $(OFILES) src/build/dump.o
	$(CC) -o esdump $(LDFLAGS) $(OFILES) src/build/dump.o $(LIBS)

clean           :
	rm -f es $(OFILES) $(GEN) src/build/dump.o initial.o
	find src -name "*.o" -delete

distclean       : clean testclean
	rm -f config.cache config.log include/config.h Makefile cscope.out tags TAGS core cs.out config.status ltmain.sh
	rm -rf autom4te.cache

MANIFEST        :
	find . -type f | sed s/..// > MANIFEST

install         : es
	$(MKDIR_P) $(DESTDIR)$(bindir)
	$(INSTALL_PROGRAM) -s es $(DESTDIR)$(bindir)
	$(MKDIR_P) $(DESTDIR)$(mandir)/man1
	$(INSTALL_DATA) $(srcdir)/doc/es.1 $(DESTDIR)$(mandir)/man1
	$(MKDIR_P) $(DESTDIR)$(datadir)/es
	$(INSTALL_DATA) $(srcdir)/share/* $(DESTDIR)$(datadir)/es

testrun         : $(testdir)/testrun.c
	$(CC) -o testrun $(testdir)/testrun.c

test            : es testrun $(testdir)/test.es
	./es -ps < $(testdir)/test.es $(testdir)/tests/*

testclean       :
	rm -f testrun

src             :
	@echo parse.y $(CFILES) $(HFILES)

y.tab.h         : src/parser/parse.y
	$(YACC) -vd $(srcdir)/src/parser/parse.y

y.tab.c         : y.tab.h

token.h         : y.tab.h
	-cmp -s y.tab.h token.h || cp y.tab.h token.h

initial.c       : esdump $(srcdir)/initial.es
	./esdump < $(srcdir)/initial.es > initial.c

sigmsgs.c       : mksignal $(SIGFILES)
	sh $(srcdir)/mksignal $(SIGFILES) > sigmsgs.c

include/config.h : config.h.in
	./configure

# Update dependencies for new structure
src/core/main.o        : src/core/main.c include/es.h include/config.h include/stdenv.h
src/core/eval.o        : src/core/eval.c include/es.h include/config.h include/stdenv.h
src/core/gc.o          : src/core/gc.c include/es.h include/config.h include/stdenv.h include/gc.h

src/primitives/prim.o     : src/primitives/prim.c include/es.h include/config.h include/stdenv.h include/prim.h
src/primitives/prim-ctl.o : src/primitives/prim-ctl.c include/es.h include/config.h include/stdenv.h include/prim.h
src/primitives/prim-etc.o : src/primitives/prim-etc.c include/es.h include/config.h include/stdenv.h include/prim.h
src/primitives/prim-io.o  : src/primitives/prim-io.c include/es.h include/config.h include/stdenv.h include/gc.h include/prim.h
src/primitives/prim-math.o : src/primitives/prim-math.c include/es.h include/config.h include/stdenv.h include/prim.h
src/primitives/prim-sys.o : src/primitives/prim-sys.c include/es.h include/config.h include/stdenv.h include/prim.h

src/parser/syntax.o    : src/parser/syntax.c include/es.h include/config.h include/stdenv.h include/input.h include/syntax.h token.h
src/parser/token.o     : src/parser/token.c include/es.h include/config.h include/stdenv.h include/input.h include/syntax.h token.h

src/io/input.o         : src/io/input.c include/es.h include/config.h include/stdenv.h include/input.h
src/io/heredoc.o       : src/io/heredoc.c include/es.h include/config.h include/stdenv.h include/gc.h include/input.h include/syntax.h
src/io/fd.o            : src/io/fd.c include/es.h include/config.h include/stdenv.h
src/io/open.o          : src/io/open.c include/es.h include/config.h include/stdenv.h
src/io/proc.o          : src/io/proc.c include/es.h include/config.h include/stdenv.h include/prim.h
src/io/term.o          : src/io/term.c include/es.h include/config.h include/stdenv.h include/gc.h

src/data/str.o         : src/data/str.c include/es.h include/config.h include/stdenv.h include/gc.h include/print.h
src/data/list.o        : src/data/list.c include/es.h include/config.h include/stdenv.h include/gc.h
src/data/split.o       : src/data/split.c include/es.h include/config.h include/stdenv.h include/gc.h
src/data/glom.o        : src/data/glom.c include/es.h include/config.h include/stdenv.h include/gc.h
src/data/conv.o        : src/data/conv.c include/es.h include/config.h include/stdenv.h include/print.h
src/data/dict.o        : src/data/dict.c include/es.h include/config.h include/stdenv.h include/gc.h
src/data/tree.o        : src/data/tree.c include/es.h include/config.h include/stdenv.h include/gc.h
src/data/vec.o         : src/data/vec.c include/es.h include/config.h include/stdenv.h include/gc.h

src/utils/debug.o      : src/utils/debug.c include/es.h include/config.h include/stdenv.h include/debug.h
src/utils/print.o      : src/utils/print.c include/es.h include/config.h include/stdenv.h include/print.h
src/utils/match.o      : src/utils/match.c include/es.h include/config.h include/stdenv.h
src/utils/glob.o       : src/utils/glob.c include/es.h include/config.h include/stdenv.h include/gc.h
src/utils/util.o       : src/utils/util.c include/es.h include/config.h include/stdenv.h
src/utils/var.o        : src/utils/var.c include/es.h include/config.h include/stdenv.h include/gc.h

src/system/access.o    : src/system/access.c include/es.h include/config.h include/stdenv.h include/prim.h
src/system/signal.o    : src/system/signal.c include/es.h include/config.h include/stdenv.h include/sigmsgs.h
src/system/status.o    : src/system/status.c include/es.h include/config.h include/stdenv.h
src/system/history.o   : src/system/history.c include/es.h include/config.h include/stdenv.h include/gc.h include/input.h
src/system/opt.o       : src/system/opt.c include/es.h include/config.h include/stdenv.h
src/system/except.o    : src/system/except.c include/es.h include/config.h include/stdenv.h include/print.h
src/system/closure.o   : src/system/closure.c include/es.h include/config.h include/stdenv.h include/gc.h

src/build/dump.o       : src/build/dump.c include/es.h include/config.h include/stdenv.h
src/build/version.o    : src/build/version.c include/es.h include/config.h include/stdenv.h

y.tab.o         : y.tab.c include/es.h include/config.h include/stdenv.h include/input.h include/syntax.h
sigmsgs.o       : sigmsgs.c include/es.h include/config.h include/stdenv.h include/sigmsgs.h